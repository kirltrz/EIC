// This file was generated by SquareLine Studio
// SquareLine Studio version: SquareLine Studio 1.5.1
// LVGL version: 9.1.0
// Project name: EIC

#include "ui.h"
#include "Arduino.h"
#include "ota.h"
#include "Wire.h"
#include "motion.h"
#include "arm.h"
#include "sensor.h"
#include "ZDTX42V2.h"
#include "LED.h"

void toNextPos(lv_event_t * e)
{
	/*currentState = COARSE_POSITIONING;*/
}

void lockCurrentPos(lv_event_t * e)
{
	// 静态变量记录当前状态：是否已锁定位置
	static bool is_position_locked = false;
	
	// 获取当前位置
	global_position_t currentPosition;
	getGlobalPosition(&currentPosition);
	
	if (!is_position_locked) {
		// 当前未锁定，按下按钮后锁定当前位置
		POS currentPos = {currentPosition.x, currentPosition.y, currentPosition.rawYaw};
		
		// 重要：先调用stopMotion停止任何现有运动，然后再锁定位置
		stopMotion();
		delay(50); // 短暂延时，确保电机停止
		
		// 现在锁定在当前位置
		moveTo(currentPos); // 移动到当前位置（实际上是锁定位置）
		
		// 修改按钮显示文本
		lv_obj_t * btn = (lv_obj_t *)lv_event_get_target(e);
		lv_obj_t * label = lv_obj_get_child(btn, 0);
		if (label != NULL) {
			lv_label_set_text(label, "解锁位置");
		}
		
		// 更新状态
		is_position_locked = true;
	} else {
		// 当前已锁定，按下按钮后解锁
		stopMotion();
		delay(50);  // 短暂延时，确保电机完全停止
		
		// 恢复按钮显示文本
		lv_obj_t * btn = (lv_obj_t *)lv_event_get_target(e);
		lv_obj_t * label = lv_obj_get_child(btn, 0);
		if (label != NULL) {
			lv_label_set_text(label, "锁定位置");
		}
		
		// 更新状态
		is_position_locked = false;
	}
}

void enableMotor(lv_event_t * e)
{
	// 获取开关状态
	lv_obj_t * sw = (lv_obj_t *)lv_event_get_target(e);
	bool is_checked = lv_obj_has_state(sw, LV_STATE_CHECKED);
	
	if (is_checked) {
		// 开关打开，使能电机
		motor->enControl(MOTOR_BROADCAST,is_checked);
		LED(1);
		DEBUG_LOG("电机已使能");
	} else {
		// 开关关闭，失能电机
		motor->enControl(MOTOR_BROADCAST,is_checked);
		LED(0);
		DEBUG_LOG("电机已失能");
	}
}

void armTestFunc(lv_event_t * e)
{
	startArmTest();
}

void servoSetOringin(lv_event_t * e)
{
	setOriginPoint();
}

void stopServo(lv_event_t * e)
{
	stopArm(false);
}

void startOTA(lv_event_t * e)
{
	initOTA();
}
